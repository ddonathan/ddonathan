<!DOCTYPE html>
<html lang="en">

<head>
  <title>THQ Proposal Pricing</title>
  <link rel="shortcut icon" type="image/png" href="favicon.png" />
  <!-- Bootstrap -->
  <!-- Required meta tags -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous" />

  <!-- Docx Templater -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.19.7/docxtemplater.js"></script>
  <script src="https://unpkg.com/pizzip@3.0.6/dist/pizzip.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.js"></script>
  <script src="https://unpkg.com/pizzip@3.0.6/dist/pizzip-utils.js"></script>
  <!--
    Mandatory in IE 6, 7, 8 and 9.
    -->
  <!--[if IE]>
        <script type="text/javascript" src="https://unpkg.com/pizzip@3.0.6/dist/pizzip-utils-ie.js"></script>
    <![endif]-->
  <script>
    var formatter = new Intl.NumberFormat("en-US", {
      style: "currency",
      currency: "USD",
      maximumSignificantDigits: 4,
    });

    var fmtPct = new Intl.NumberFormat("en-US", {
      style: "percent",
    });

    //
    // Save Draft, get shortURL
    //
    function saveDraft() {
      let linkURL = document.getElementById("linkURL").href
      linkURL = linkURL.replace("file:///C:/Source/", "https://ddonathan.github.io/")
      console.log(linkURL)

      var myHeaders = new Headers();
      myHeaders.append("Content-Type", "application/json");
      myHeaders.append("Accept", "application/json");

      var raw = JSON.stringify({
        "long_url": linkURL,
        "domain": "https://thq.li/",
        "api_token": "VOBpwXojb2qnELypxb1XwiGaYnH07Cy3oAX6SnRSQA4qbM09Sj3CP7EHbaKz"
      });

      var requestOptions = {
        method: 'POST',
        headers: myHeaders,
        body: raw,
        redirect: 'follow'
      };

      fetch("https://t.ly/api/v1/link/shorten", requestOptions)
        .then(response => response.json())
        .then(result => {
          document.getElementById("shortUrl_tr").className = ""
          document.getElementById("shortUrl").innerHTML = result.short_url
          document.getElementById("shortUrl2").innerHTML = result.short_url
        })
        .catch(error => console.log('error', error));
    }


    // 
    // Load File
    // 
    function loadFile(url, callback) {
      PizZipUtils.getBinaryContent(url, callback);
    }

    // 
    // Generate
    // 
    function generate() {
      loadFile("template.docx", function (error, content) {
        if (error) { throw error };

        // The error object contains additional information when logged with JSON.stringify (it contains a properties object containing all suberrors).
        function replaceErrors(key, value) {
          if (value instanceof Error) {
            return Object.getOwnPropertyNames(value).reduce(function (error, key) {
              error[key] = value[key];
              return error;
            }, {});
          }
          return value;
        }

        function errorHandler(error) {
          console.log(JSON.stringify({ error: error }, replaceErrors));

          if (error.properties && error.properties.errors instanceof Array) {
            const errorMessages = error.properties.errors.map(function (error) {
              return error.properties.explanation;
            }).join("\n");
            console.log('errorMessages', errorMessages);
            // errorMessages is a humanly readable message looking like this :
            // 'The tag beginning with "foobar" is unopened'
          }
          throw error;
        }

        var zip = new PizZip(content);
        var doc;
        try {
          doc = new window.docxtemplater(zip, { paragraphLoop: true })
        } catch (error) {
          // Catch compilation errors (errors caused by the compilation of the template : misplaced tags)
          errorHandler(error);
        }

        // Convert input to JSON
        dataToSend = JSON.parse(document.getElementById("rawOutput").innerHTML);

        // Format dollar amounts if we have them (and remove dollar sign from template)
        dataToSend.onSiteTrainingAmt = formatter.format(dataToSend.onSiteTrainingAmt);
        dataToSend.afterCareAmt = formatter.format(dataToSend.afterCareAmt);
        dataToSend.totalAmt = formatter.format(dataToSend.totalAmt);

        // If needed to convert number to word
        var dg = ["zero", "one", "two", "three", "four", "five", "six", "seven", "eight", "nine"]

        // Convert numbers to words
        dataToSend.plCount = dg[dataToSend.plCount]
        dataToSend.npeCount = dg[dataToSend.npeCount]
        dataToSend.oscpCount = dg[dataToSend.oscpCount]

        // Convert numPayments
        let paymentNumber = dg[dataToSend.numPayments]
        dataToSend[`payments_${paymentNumber}`] = true

        // Send to document creation
        doc.setData(dataToSend);
        try {
          // render the document (replace all occurences of {first_name} by John, {last_name} by Doe, ...)
          doc.render();
        }
        catch (error) {
          // Catch rendering errors (errors relating to the rendering of the template : angularParser throws an error)
          errorHandler(error);
        }

        var out = doc.getZip().generate({
          type: "blob",
          mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
        }) //Output the document using Data-URI
        saveAs(out, `${dataToSend.companyName} - Tonic HQ Implementation.docx`)
      })
    }

    function QueryStringToJSON() {
      var pairs = location.search.slice(1).split("&");

      var result = {};
      pairs.forEach(function (pair) {
        pair = pair.split("=");
        result[pair[0]] = decodeURIComponent(pair[1] || "").replace("+", " ");
      });

      return JSON.parse(JSON.stringify(result));
    }

    // save query_string
    var query_string = QueryStringToJSON();

    // 
    // OnLoad
    // 
    window.onload = function () {

      var form = document.querySelector("form");
      form.addEventListener("change", function () {
        calculatePricing();
        funcOnSiteTraining();
        funcAfterCare();
      });

      // Set reset form url to the url they came in with
      document.getElementById("resetForm").addEventListener("click", function () {
        window.location = window.location.href;
      });
      document.getElementById("resetForm").addEventListener("dblclick", function () {
        window.location = "proposalCalculator.html";
      });

      // Initialize all tooltips
      var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
      var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
      })

      // Set values from the querystring
      for (let key in query_string) {

        // used to hold the value through this loop
        fieldId = key

        // If we have a products list, then split it out
        if (fieldId === "products") {
          products = query_string[fieldId].split(",")

          // Loop through them and set the keyValue so we can use it to set the values in the form
          for (let product of products) {
            if (document.getElementsByName(product)) fieldId = document.getElementsByName(product)[0].id
          }
        }

        // If it's a checkbox, check it, otherwise set the value
        if (document.getElementById(fieldId) && document.getElementById(fieldId).type === "checkbox") document.getElementById(fieldId).checked = true;
        if (document.getElementById(fieldId) && document.getElementById(fieldId).type !== "checkbox") document.getElementById(fieldId).value = query_string[fieldId];
      }

      // Set focus to companyName
      document.getElementById("companyName").focus();

      // Trigger the pricing to be calculated
      calculatePricing();
    };

    function calculatePricing() {

      // Remove and hide the link
      document.getElementById("shortUrl_tr").className = "d-none"
      document.getElementById("shortUrl").innerHTML = ""
      document.getElementById("shortUrl2").innerHTML = ""


      // lookup
      var container = {
        query_string: query_string,
        lookup: {
          buffer: 0.1,
          padding: 2000,
          paddingBBO: 4000,
          paddingBH1: 25000,
          baseUserPrice: 1050,
          products: {
            ats: {
              name: "ATS",
              pricing: "65"
            },
            crm: {
              name: "CRM",
              pricing: "20"
            },
            time_expense: {
              name: "Time/Expense",
              pricing: "65"
            },
            invoicing: {
              name: "Invoicing",
              pricing: "65"
            },
            pay_bill: {
              name: "Pay/Bill",
              pricing: "2650"
            },
            onboarding: {
              name: "Onboarding",
              pricing: "65"
            },
            vms_submittals: {
              name: "VMS Submittals",
              pricing: "30"
            },
            vms_sync: {
              name: "VMS Sync",
              pricing: "30"
            },
            canvas: {
              name: "Canvas",
              pricing: "65"
            }
          },
          additions: {
            newHireExport: {
              pricing: 500,
              method: "$"
            },
            qbIntegration: {
              pricing: 500,
              method: "$"
            },
            InvoiceExport: {
              pricing: 500,
              method: "$"
            },
            PayDataExport: {
              pricing: 500,
              method: "$"
            },
            plCount: {
              pricing: 1250,
              include: 1,
              method: "$"
            },
            npeCount: {
              pricing: 2500,
              addtlPricing: 1250,
              method: "$"
            },
            oscpCount: {
              pricing: 500,
              addtlPricing: 250,
              method: "$"
            },
            histSubmissions: {
              pricing: 1250,
              method: "$"
            },
            emailsAsNotes: {
              pricing: .07,
              method: "%"
            },
            NoDataMigration: {
              pricing: -.15,
              method: "%"
            },
            oscpOption: {
              pricing: 500,
              addtlPricing: 250,
              method: "$"
            },
            onSiteTraining: {
              pricing: 2500,
              method: "$"
            },
            afterCare: {
              pricing: .15,
              method: "%"
            }
          }
        },
        data: {},
        calcs: {
          isBBO: false,
          productsPrice: 0,
          pricePerUser: 0,
          additions: 0,
        },
      };

      // // Get data from the form
      // container.data = {};
      container.data.products = [];

      // // Setup for sending to document creation
      // container.data = container.data;

      // Loop through the form data to get into the container
      var form = document.getElementById("form");
      var data = new FormData(form);
      for (var [key, value] of data) {
        container.data[key] = value;
      }

      // Process products
      Object.entries(container.lookup.products).forEach(entry => {
        let [key, value] = entry;
        if (document.getElementById(key).checked) {

          // Put the name into the products array
          container.data.products.push(value.name);

          // Add to pricing
          container.calcs.productsPrice += Number(value.pricing);

          // Set backoffice based on the product choices
          if (key === "time_expense" || key === "invoicing") {
            container.data.backoffice = "BBO";
            container.data.isBBO = true;
          }
          if (key === "pay_bill") {
            container.data.isBH1 = true;
            container.data.backoffice = "BH1"
          }
        }
        // Commenting this out until we have a way to loop through the products list and set the checkboxes
        // delete container.data[key];
      })

      // Find Volume container.lookup.discount
      container.data.userCount = Number(container.data.userCount);
      switch (true) {
        case container.data.userCount >= 100:
          container.lookup.discount = .5;
          break;
        case container.data.userCount >= 60:
          container.lookup.discount = .4;
          break;
        case container.data.userCount >= 40:
          container.lookup.discount = .4;
          break;
        case container.data.userCount >= 20:
          container.lookup.discount = .35;
          break;
        case container.data.userCount >= 15:
          container.lookup.discount = .3;
          break;
        default:
          container.lookup.discount = 0;
          break;
      }
      if (container.lookup.discount)
        document.getElementById("discount").innerHTML = fmtPct.format(
          container.lookup.discount
        );

      // If number of users is less than 3 then calculate based on 3
      container.calcs.userCountCalculated = container.data.userCount;
      if (container.calcs.userCountCalculated < 3)
        container.calcs.userCountCalculated = 3;

      // Figure out padding
      if (container.data.isBBO) container.lookup.padding = container.lookup.paddingBBO;
      if (container.data.isBH1) container.lookup.padding = container.lookup.paddingBH1;

      // Perform Calculations (round to nearest integer)
      container.calcs.pricePerUser = Math.round((container.lookup.baseUserPrice + container.calcs.productsPrice) * (1 - container.lookup.discount));
      container.calcs.basePricing = Math.round(container.calcs.pricePerUser * container.calcs.userCountCalculated);
      container.calcs.ballparkLow = roundTo(container.calcs.basePricing, 500);
      container.calcs.ballparkHigh = roundTo((container.calcs.basePricing + container.lookup.padding) * (1 + container.lookup.buffer), 500);

      // Process additions
      Object.entries(container.lookup.additions).forEach(entry => {
        let [key, value] = entry;

        // Set pricing info label
        if (document.getElementById(`${key}_pricing`)) {
          let descToUse, addtlPricing

          // If method is dollars, set description and additional pricing
          if (value.method === "$") {
            descToUse = formatter.format(value.pricing);
            addtlPricing = formatter.format(value.addtlPricing)
          }

          // If method is percent, set description and calculate out additional pricing (round up to the tens)
          if (value.method === "%") {
            descToUse = formatter.format(roundTo(container.calcs.basePricing * value.pricing, 10)) + " (" + fmtPct.format(value.pricing) + ")";
            if (value.addtlPricing) addtlPricing = formatter.format(roundTo(container.calcs.basePricing * value.addtlPricing, 10)) + " (" + fmtPct.format(value.addtlPricing) + ")";
          }

          // if it's addtional pricing, add
          if (value.addtlPricing) descToUse += " first instance, " + addtlPricing + " each additional"

          // Set label
          document.getElementById(`${key}_pricing`).innerHTML = descToUse
        }

        // If they are zero, remove from the data packet
        if (container.data.npeCount === 0) delete container.data.npeCount
        if (container.data.oscpCount === 0) delete container.data.oscpCount
        if (container.data.plCount === 0) delete container.data.plCount

        // If ANY additions are marked that affect pricing
        let paidAdditions = ["newHireExport", "NoDataMigration", "plCount", "npeCount", "oscpCount", "qbIntegration", "InvoiceExport", "PayDataExport", "emailsAsNotes", "histSubmissions"]

        // If this key is included in the list of paid additions, then add it
        if (paidAdditions.indexOf(key) !== -1) {

          // Mark that we have paid additions. We will show that section in the template.
          container.data.paidAdditions = true;

          // If this form field is an input, we can expect a number
          document.getElementById(key).value
          if (document.getElementById(key).value > 0) {
            let count = document.getElementById(key).value;

            // If we include some, then factor that in.
            if (value.include > 0) count = count - value.include;
            if (count > 0) {

              // Add the first one
              container.calcs.additions += value.pricing;

              // If we have more than one
              if (count > 1) {
                // If we charge less for addditional ones, do that work first
                if (value.addtlPricing) container.calcs.additions += (count - 1) * value.addtlPricing;

                // otherwise just add in the rest
                else container.calcs.additions += (count - 1) * value.pricing;
              }
            }
          }

          // If this form field is a checkbox
          if (document.getElementById(key).type === "checkbox" && document.getElementById(key).checked) {

            // If it's a dollar amount, add it
            if (value.method === "$") container.calcs.additions += value.pricing;

            // If its a percent multiply it
            if (value.method === "%") container.calcs.additions += roundTo(container.calcs.basePricing * value.pricing, 10);
          }
        }
      })

      // Set option pricing
      console.log(event)
      if (event.target.name === "onSiteTraining" && event.target.checked) document.getElementById("onSiteTrainingAmt").value = container.lookup.additions.onSiteTraining.pricing;
      if (event.target.name === "afterCare" && event.target.checked) document.getElementById("afterCareAmt").value = roundTo((container.calcs.basePricing * container.lookup.additions.afterCare.pricing), 10);

      // Calculate Total Amount
      console.log(container.calcs.basePricing, container.calcs.additions);
      container.data.totalAmt = container.calcs.basePricing + container.calcs.additions;
      container.data.totalAmt = roundTo(container.data.totalAmt, 10);

      // Show pricing form
      document.getElementById("pricing_companyName").innerHTML = container.data.companyName;
      document.getElementById("pricing_ballpark").innerHTML = formatter.format(container.calcs.ballparkLow) + "-" + formatter.format(container.calcs.ballparkHigh);
      document.getElementById("pricing_basePricing").innerHTML = formatter.format(container.calcs.basePricing);
      document.getElementById("pricing_additions").innerHTML = formatter.format(container.calcs.additions);
      document.getElementById("pricing_totalAmt").innerHTML = formatter.format(container.data.totalAmt);

      // If we have an override price amount, put totalAmt in a separate spot and then set totalAmt to the override price
      if (container.data.overridePriceAmt && container.data.overridePriceAmt !== "0") {
        container.data.totalAmt_original = container.data.totalAmt;
        container.data.totalAmt = container.data.overridePriceAmt;
        // delete container.data.overridePriceAmt

        // Put in the pricing form
        document.getElementById("pricing_totalAmt").innerHTML = formatter.format(container.data.totalAmt_original);
        document.getElementById("pricing_totalAmt").className = "text-decoration-line-through text-muted";
        document.getElementById("pricing_totalAmt_override").innerHTML = formatter.format(container.data.totalAmt);
      } else {
        // delete container.data.overridePriceAmt
        document.getElementById("pricing_totalAmt").className = "";
        document.getElementById("pricing_totalAmt_override").innerHTML = "";
      }

      // Number of weeks
      container.data.timelineWeeks = container.data.timelineLow + " - " + container.data.timelineHigh + " weeks";
      // delete container.data.timelineLow;
      // delete container.data.timelineHigh;

      // Set timeline
      if (container.data.timelineTable) container.data[`timeline${container.data.timelineTable}`] = true;

      // Build URL to link to
      let baseURL = window.location.href + "?";
      let linkURL = "";
      for (const key in container.data) {
        if (container.data[key]) linkURL += "&" + `${key}=${container.data[key]}`;
      }
      document.getElementById('linkURL').setAttribute('href', baseURL + encodeURI(linkURL));

      // Save to textarea
      document.getElementById("rawOutput").innerHTML = JSON.stringify(
        container.data,
        null,
        4
      );

      // Run functions
      funcBackOfficeOptions();
      funcOnSiteTraining();
      funcAfterCare();
      // functimelineTable();

      // Test that the form is valid first
      checkValid(container);



      // Cleanup before logging
      container.data = removeFalsy(container.data);
      container.data = removeFalsy(container.data);
      delete container.calcs.isBBO
      delete container.data.isBBO
      delete container.data.paidAdditions
      delete container.data.timelineLow
      delete container.data.timelineHigh
      console.log(JSON.stringify(container, null, 4));
      document.getElementById("dataOutput").innerHTML = JSON.stringify({
        calcs: container.calcs,
        data: container.data
      }, null, 4)
    }

    // 
    // Check that a form is valid and show alerts
    // 
    function checkValid(container) {
      let alertText = "";
      let validationErrors = []
      let validationWarnings = [];

      if (!document.getElementById("companyName").value) validationErrors.push(" - Company Name not provided")

      if (!document.getElementById("existingSystem").value) validationErrors.push("  - Existing System not provided")

      if (!document.getElementById("timelineTable").value) validationErrors.push("  - Timeline table not selected")

      if (container.data.totalAmt > 15000 && document.getElementById("numPayments").value === "2") validationWarnings.push(`  - Price is ${formatter.format(container.data.totalAmt)} and it's set to just two payments`)

      if (container.data.userCount > 15 && document.getElementById("timelineLow").value <= "13") validationWarnings.push(`  - User count is ${container.data.userCount} and timeline is ${container.data.timelineWeeks}`)

      //  if the form isn't valid, show the message and 
      if (validationErrors.length === 0 && validationWarnings.length === 0) {
        document.getElementById("validationMsg_div").className = "d-none";
        document.getElementById("validationMsg").innerHTML = "";
        document.getElementById("generateProposal").className = "btn btn-primary";
      } else {
        // SHow the alert box
        document.getElementById("validationMsg_div").className = "";

        // If it's an error, show them
        if (validationErrors.length > 0) alertText = "<strong>Alerts:</strong> <br>" + validationErrors.join("<br>") + "<br>";

        // If it's a warning, show them
        if (validationWarnings.length > 0) {
          alertText += "<strong>Warnings:</strong> <br>" + validationWarnings.join("<br>");
          document.getElementById("validationMsg").className = "alert alert-warning alert-dismissible fade show";
        }
        if (validationErrors.length > 0) document.getElementById("validationMsg").className = "alert alert-danger alert-dismissible fade show";

        // Hide Generate Proposal
        document.getElementById("generateProposal").className = "btn btn-primary d-none";

        // Finish up alertText and set it
        alertText += '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"  data-bs-toggle="tooltip" data-bs-placement="right" title="Closing this alert will allow you to generate the proposal" onclick="checkValidOverride();"></button>';
        document.getElementById("validationMsg").innerHTML = alertText
      }
    }

    function checkValidOverride() {
      document.getElementById("generateProposal").className = "btn btn-primary";
    }

    // Remove Falsy Function
    const removeFalsy = (obj) => {
      let newObj = {};
      Object.keys(obj).forEach((prop) => {
        if (obj[prop]) { newObj[prop] = obj[prop]; }
      });
      return newObj;
    };

    // Round to the nearest 10, 100, 500, etc.
    function roundTo(amount, roundTo) {
      amount = Math.ceil(amount / roundTo) * roundTo;
      return amount
    }

    // Form automation
    function funcBackOfficeOptions(backoffice) {

      // If it's BBO
      if (backoffice === "BBO" && event.target.checked) {
        document.getElementById("pay_bill").checked = false;

        // Set labels
        document.getElementById("pay_bill_label").className = "form-check-label text-black-50";
        document.getElementById("time_expense_label").className = "form-check-label";
        document.getElementById("invoicing_label").className = "form-check-label";
      }

      // If it's BH1
      if (backoffice === "BH1" && event.target.checked) {
        document.getElementById("time_expense").checked = false;
        document.getElementById("invoicing").checked = false;

        // Set the timeline template
        document.getElementById("timelineTable").value = "BH1";

        // Set labels
        document.getElementById("pay_bill_label").className = "form-check-label";
        document.getElementById("time_expense_label").className = "form-check-label text-black-50";
        document.getElementById("invoicing_label").className = "form-check-label text-black-50";
      }

      // If it's either one, unhide the backoffice options. If it's neither, hide them and reset the labels
      if (document.getElementById("pay_bill").checked || document.getElementById("time_expense").checked || document.getElementById("invoicing").checked) {
        document.getElementById("backoffice_options_div").className = "row mb-3";
      }
      else {
        document.getElementById("backoffice_options_div").className = "row mb-3 d-none";
        document.getElementById("time_expense_label").className = "form-check-label";
        document.getElementById("invoicing_label").className = "form-check-label";
        document.getElementById("pay_bill_label").className = "form-check-label";
      }

      // If time/expense then show pay data export is checked then hide invoicing as an option
      if (document.getElementById("time_expense").checked) {
        document.getElementById("PayDataExport_div").className = "form-check form-switch";
      }
      else {
        document.getElementById("PayDataExport").checked = false;
        document.getElementById("PayDataExport_div").className = "form-check form-switch d-none";
      }
      // If invoicing then show invoice export as an option
      if (document.getElementById("invoicing").checked) {
        // If quickbooks is checked then hide invoicing as an option
        if (document.getElementById("qbIntegration").checked) {
          document.getElementById("InvoiceExport").checked = false;
          document.getElementById("InvoiceExport_div").className = "form-check form-switch d-none";
        }
        else {
          document.getElementById("InvoiceExport_div").className = "form-check form-switch";
        }
      }
      else {
        document.getElementById("InvoiceExport").checked = false;
        document.getElementById("InvoiceExport_div").className = "form-check form-switch d-none";
      }

      // Before we wrap up, test all the checkboxes and show only what's appropriate
      // If pay/bill is checked we'll show both invoice and pay data export
      if (event.target.name === "pay_bill" && document.getElementById("pay_bill").checked === true) {
        document.getElementById("backoffice_options_div").className = "row mb-3";
        document.getElementById("InvoiceExport_div").className = "form-check form-switch";
        document.getElementById("PayDataExport_div").className = "form-check form-switch";
      }

      if (event.target.name === "pay_bill" && document.getElementById("pay_bill").checked === false) {
        // Uncheck and hide the options
        document.getElementById("PayDataExport_div").className = "form-check form-switch d-none";
        document.getElementById("InvoiceExport_div").className = "form-check form-switch d-none";
        document.getElementById("qbIntegration").checked = false;
        document.getElementById("InvoiceExport").checked = false;
        document.getElementById("PayDataExport").checked = false;

        // If applicable, enable the checkboxes
        if (document.getElementById("invoicing").checked) document.getElementById("InvoiceExport_div").className = "form-check form-switch";
        if (document.getElementById("time_expense").checked) document.getElementById("PayDataExport_div").className = "form-check form-switch";
      }
    }

    function funcOnSiteTraining() {
      if (document.getElementById("onSiteTraining").checked) document.getElementById("onSiteTraining_div").className = "col-sm-2";
      else document.getElementById("onSiteTraining_div").className = "d-none";
    }

    function funcAfterCare() {
      if (document.getElementById("afterCare").checked) document.getElementById("afterCare_div").className = "col-sm-2";
      else document.getElementById("afterCare_div").className = "d-none";
    }

    function functimelineTable() {
      switch (document.getElementById("timelineTable").value) {
        case "NoDM":
          document.getElementById("timelineLow").value = "9";
          document.getElementById("timelineHigh").value = "12";
          break;
        case "SMB":
          document.getElementById("timelineLow").value = "10";
          document.getElementById("timelineHigh").value = "16";
          break;
        case "Field":
          document.getElementById("numPayments").value = "3";
          document.getElementById("timelineLow").value = "13";
          document.getElementById("timelineHigh").value = "18";
          break;
        case "BH1":
          document.getElementById("numPayments").value = "3";
          document.getElementById("timelineLow").value = "24";
          document.getElementById("timelineHigh").value = "36";
          break;
        default:
          break;
      }
    }
  </script>
</head>

<body>
  <div class="container-md">
    <form action="proposalCalculator.html" id="form" name="form" method="GET" class="needs-validation" novalidate>
      <h1 class="display-6" onclick="window.location='proposalCalculator.html'">Tonic HQ Pricing Calculator</h1>
      <br>

      <h5>Basic Information</h5>
      <div class="row mb-3">
        <div class="col-sm-2">Company Name</div>
        <div class="col-sm-6">
          <input type="text" class="form-control" id="companyName" name="companyName" required>
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-sm-2">Existing System</div>
        <div class="col-sm-6">
          <input type="text" class="form-control" id="existingSystem" name="existingSystem">
        </div>
      </div>

      <!-- TODO
      <div class="row mb-3">
        <div class="col-sm-2">Additional Datasources</div>
        <div class="col-sm-6">
          <input type="text" class="form-control" id="addtlDatasources" name="addtlDatasources" required>
        </div>
      </div> -->

      <div class="row mb-3">
        <div class="col-sm-2">Number of Users</div>
        <div class="col-sm-2">
          <input type="number" class="form-control" id="userCount" name="userCount" value="10" min="1" max="150" />
        </div>
      </div>
      <br />
      <div class="row mb-3">
        <div class="col-sm-2">Products</div>
        <div class="col-sm-auto">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="ats" name="ATS" value="true" CHECKED>
            <label class="form-check-label" for="ats">
              ATS
            </label>
          </div>
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="crm" name="CRM" value="true">
            <label class="form-check-label" for="crm">
              CRM
            </label>
          </div>
          <div class="form-check form-switch" id="time_expense_div">
            <input class="form-check-input" type="checkbox" id="time_expense" name="Time/Expense" value="true" onchange="funcBackOfficeOptions('BBO');">
            <label class="form-check-label" id="time_expense_label" for="time_expense">
              Time/Expense
            </label>
          </div>
          <div class="form-check form-switch" id="invoicing_div">
            <input class="form-check-input" type="checkbox" id="invoicing" name="Invoicing" value="true" onchange="funcBackOfficeOptions('BBO');">
            <label class="form-check-label" id="invoicing_label" for="invoicing">
              Invoicing
            </label>
          </div>
          <div class="form-check form-switch" id="pay_bill_div">
            <input class="form-check-input" type="checkbox" id="pay_bill" name="Pay/Bill" value="true" onchange="funcBackOfficeOptions('BH1');">
            <label class="form-check-label" id="pay_bill_label" for="pay_bill">
              Pay/Bill <span class="badge bg-secondary bg-warning text-dark">Testing</span>
            </label>
          </div>
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="onboarding" name="Onboarding" value="true">
            <label class="form-check-label" for="onboarding">
              Onboarding
            </label>
          </div>
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="vms_submittals" name="VMS Submittals" value="true">
            <label class="form-check-label" for="vms_submittals">
              VMS Submittals
            </label>
          </div>
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="vms_sync" name="VMS Sync" value="true">
            <label class="form-check-label" for="vms_sync">
              VMS Sync
            </label>
          </div>
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="canvas" name="Canvas" value="true">
            <label class="form-check-label" for="canvas">
              Canvas
            </label>
          </div>
        </div>
      </div>


      <div class="accordion" id="accordionExample">
        <div class="accordion-item">
          <h2 class="accordion-header" id="headingAdditions">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAdditions" aria-expanded="false" aria-controls="collapseAdditions">
              <h5>Additions</h5>
            </button>
          </h2>
          <div id="collapseAdditions" class="accordion-collapse collapse" aria-labelledby="headingAdditions" data-bs-parent="#accordionExample">
            <div class="accordion-body">
              <div class="row mb-3 d-none" id="backoffice_options_div">
                <div class="col-sm-2">Back Office Options</div>
                <div class="col-sm-6">
                  <div id="qbIntegration_div" class="form-check form-switch">
                    <input class="form-check-input position-static" type="checkbox" id="qbIntegration" name="qbIntegration" value="true" />
                    Quickbooks Integration <small><span class="text-black-50" id="qbIntegration_pricing"></span></small>
                  </div>
                  <div id="InvoiceExport_div" class="form-check form-switch">
                    <input class="form-check-input position-static" type="checkbox" id="InvoiceExport" name="InvoiceExport" value="true" />
                    Invoice Export <small><span class="text-black-50" id="InvoiceExport_pricing"></span></small>
                  </div>
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-sm-2">Payroll Reports</div>
                <div class="col-sm">
                  <div class="form-check form-switch">
                    <input class="form-check-input position-static" type="checkbox" id="newHireExport" name="newHireExport" value="true" /> New Hire Export <small><span class="text-black-50" id="newHireExport_pricing"></span></small>
                  </div>
                  <div id="PayDataExport_div" class="form-check form-switch">
                    <input class="form-check-input position-static" type="checkbox" id="PayDataExport" name="PayDataExport" value="true" />
                    Pay Data Export <small><span class="text-black-50" id="PayDataExport_pricing"></span></small>
                  </div>
                </div>
              </div>

              <div class="form-group row mb-3">
                <div class="col-sm-2">Private Labels</div>
                <div class="col-sm-2">
                  <input type="number" class="form-control" id="plCount" name="plCount" value="1" min="1" max="5" />
                </div>
                <div class="col-sm-6">
                  <small><span class="text-black-50" id="plCount_pricing"></span></small> <span class="text-black-50" id="plCount_addtl"></span></small>
                </div>
              </div>

              <div class="form-group row mb-3">
                <div class="col-sm-2">Non-Production Environments</div>
                <div class="col-sm-2">
                  <input type="number" class="form-control" id="npeCount" name="npeCount" min="0" max="5" />
                </div>
                <div class="col-sm-6">
                  <small><span class="text-black-50" id="npeCount_pricing"></span></small> <span class="text-black-50" id="plCount_addtl"></span></small>
                </div>
              </div>

              <div class="form-group row mb-3">
                <div class="col-sm-2">OSCPs</div>
                <div class="col-sm-2">
                  <input type="number" class="form-control" id="oscpCount" name="oscpCount" min="0" max="5" />
                </div>
                <div class="col-sm-6">
                  <small><span class="text-black-50" id="oscpCount_pricing"></span></small> <span class="text-black-50" id="plCount_addtl"></span></small>
                </div>
              </div>
              <br />

              <div class="row mb-3">
                <div class="col-sm-2">Other Options</div>
                <div class="col-sm-6">
                  <div class="form-check form-switch">
                    <input class="form-check-input position-static" type="checkbox" id="emailsAsNotes" name="emailsAsNotes" value="true" />Importing emails as notes <small><span class="text-black-50" id="emailsAsNotes_pricing"></span></small>
                  </div>
                  <div class="form-check form-switch">
                    <input class="form-check-input position-static" type="checkbox" id="NoDataMigration" name="NoDataMigration" value="true" />Do not perform data migration <small><span class="text-black-50" id="NoDataMigration_pricing"></span></small>
                  </div>
                  <div class="form-check form-switch">
                    <input class="form-check-input position-static" type="checkbox" id="histSubmissions" name="histSubmissions" value="true" />Load historical submissions <small><span class="text-black-50" id="histSubmissions_pricing"></span></small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="accordion-item">
          <h2 class="accordion-header" id="headingOptTHQ">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOptTHQ" aria-expanded="false" aria-controls="collapseOptTHQ">
              <h5>Optional THQ Offerings</h5>
            </button>
          </h2>
          <div id="collapseOptTHQ" class="accordion-collapse collapse" aria-labelledby="headingOptTHQ" data-bs-parent="#accordionExample">
            <div class="accordion-body">
              <div class="alert alert-secondary" role="alert">
                Enabling will show the item on the proposal, it does not include it in the price. You can alter the price that's shown on the proposal.
              </div>
              <div class="form-group row mb-3">
                <div class="col-sm-2">OSCP</div>
                <div class="col-sm-6">
                  <div class="form-check form-switch mb-3">
                    <input class="form-check-input position-static" type="checkbox" id="oscpOption" name="oscpOption" value="true" /> <small><span class="text-black-50" id="oscpOption_pricing"></span></small>
                  </div>
                </div>
              </div>

              <div class="form-group row mb-3">
                <div class="col-sm-2">On Site Training</div>
                <div class="col-sm-6">
                  <div class="form-check form-switch mb-3">
                    <input class="form-check-input position-static" type="checkbox" id="onSiteTraining" name="onSiteTraining" value="true" onchange="funcOnSiteTraining();" /> <small><span class="text-black-50" id="onSiteTraining_pricing"></span></small>
                  </div>
                  <div class="col-sm-3 d-none" id="onSiteTraining_div">
                    <input class="form-control" type="number" id="onSiteTrainingAmt" name="onSiteTrainingAmt" value="" />
                  </div>
                </div>
              </div>

              <div class="form-group row mb-3">
                <div class="col-sm-2">White Glove</div>
                <div class="col-sm-6">
                  <div class="form-check form-switch mb-3">
                    <input class="form-check-input position-static" type="checkbox" id="afterCare" name="afterCare" value="true" onchange="funcAfterCare();" /> <small><span class="text-black-50" id="afterCare_pricing"></span></small>
                  </div>
                  <div class="col-sm-3 d-none" id="afterCare_div">
                    <input class="form-control" type="number" id="afterCareAmt" name="afterCareAmt" value="" />
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="accordion-item">
          <h2 class="accordion-header" id="headingBilling">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBilling" aria-expanded="false" aria-controls="collapseBilling">
              <h5>Billing and Timeline</h5>
            </button>
          </h2>
          <div id="collapseBilling" class="accordion-collapse collapse" aria-labelledby="headingBilling" data-bs-parent="#accordionExample">
            <div class="accordion-body">
              <div class="row mb-3">
                <div class="col-sm-2" data-bs-toggle="tooltip" data-bs-placement="right" title="This determines the timeline table that will be used in the proposal">Timeline Table to use</div>
                <div class="col-sm-3">
                  <select name="timelineTable" id="timelineTable" class="form-select" aria-label="" onchange="functimelineTable();" REQUIRED>
                    <option value="" SELECTED>-- Please Select --</option>
                    <option value="NoDM">No Data Migration</option>
                    <option value="SMB">SMB</option>
                    <option value="Field">Field</option>
                    <option value="BH1">Bullhorn One</option>
                  </select>
                </div>
              </div>

              <div class="form-group row mb-3">
                <div class="col-sm-2">Timeline (weeks)</div>
                <div class="col-sm-2">
                  <div class="row mb-3">
                    <div class="col-auto">
                      <input class="form-control" type="number" id="timelineLow" name="timelineLow" value="12" min="10" max="52" />
                    </div>
                    <div class="col-3">Low</div>
                  </div>
                  <div class="row mb-3">
                    <div class="col-auto">
                      <input class="form-control" type="number" id="timelineHigh" name="timelineHigh" value="16" min="10" max="52" />
                    </div>
                    <div class="col-3">High</div>
                  </div>
                </div>
              </div>

              <div class="form-group row mb-3">
                <div class="col-sm-2">Number of Payments</div>
                <div class="col-sm-2">
                  <input class="form-control" type="number" id="numPayments" name="numPayments" value="2" min="2" max="3" />
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="accordion-item d-none">
          <h2 class="accordion-header" id="headingSigning">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSigning" aria-expanded="false" aria-controls="collapseSigning">
              <h5>Signing Recipients</h5>
            </button>
          </h2>
          <div id="collapseSigning" class="accordion-collapse collapse" aria-labelledby="headingSigning" data-bs-parent="#accordionExample">
            <div class="accordion-body">
              <div class="row mb-3">
                <div class="alert alert-warning" role="alert">
                  This is not currently in use.
                </div>
                <div class="col-sm-2">THQ Rep</div>
                <div class="col-sm-8">
                  <div class="input-group mb-3">
                    <input type="text" class="form-control" placeholder="Name" aria-label="Name" id="recThqName" name="recThqName" />
                    &nbsp;&nbsp;&nbsp;
                    <span class="input-group-text">@</span>
                    <input type="text" class="form-control" placeholder="Email" aria-label="Email" id="recThqEmail" name="recThqEmail" />
                  </div>
                </div>
              </div>

              <div class="row mb-3">
                <div class="col-sm-2">Client Signer</div>
                <div class="col-sm-8">
                  <div class="input-group mb-3">
                    <input type="text" class="form-control" placeholder="Name" aria-label="Name" id="recClientName" name="recClientName" />
                    &nbsp;&nbsp;&nbsp;
                    <span class="input-group-text">@</span>
                    <input type="text" class="form-control" placeholder="Email" aria-label="Email" id="recClientEmail" name="recClientEmail" />
                  </div>
                </div>
              </div>

              <div class="row mb-3">
                <div class="col-sm-2">Bullhorn Rep</div>
                <div class="col-sm-8">
                  <div class="input-group mb-3">
                    <input type="text" class="form-control" placeholder="Name" aria-label="Name" id="recBhName" name="recBhName" />
                    &nbsp;&nbsp;&nbsp;
                    <span class="input-group-text">@</span>
                    <input type="text" class="form-control" placeholder="Email" aria-label="Email" id="reBhEmail" name="reBhEmail" />
                  </div>
                </div>
              </div>

              <div class="row mb-3">
                <div class="col-sm-2">Additional CC</div>
                <div class="col-sm-8">
                  <div class="input-group mb-3">
                    <input type="text" class="form-control" placeholder="Name" aria-label="Name" id="recCcName" name="recCcName" />
                    &nbsp;&nbsp;&nbsp;
                    <span class="input-group-text">@</span>
                    <input type="text" class="form-control" placeholder="Email" aria-label="Email" id="reCcEmail" name="reCcEmail" />
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="accordion-item">
          <h2 class="accordion-header" id="headingMisc">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMisc" aria-expanded="false" aria-controls="collapseMisc">
              <h5>Miscellaneous</h5>
            </button>
          </h2>
          <div id="collapseMisc" class="accordion-collapse collapse" aria-labelledby="headingMisc" data-bs-parent="#accordionExample">
            <div class="accordion-body">
              <div class="form-group row mb-3">
                <div class="col-sm-2">Price Override</div>
                <div class="col-sm-2">
                  <input type="number" class="form-control" id="overridePriceAmt" name="overridePriceAmt" value="" />
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <br>
      <div class="row" id="validationMsg_div" class="d-none">
        <div class="col-sm-5">
          <div id="validationMsg" class="alert alert-warning alert-dismissible fade show"></div>
        </div>
      </div>
    </form>

    <div class="row">
      <div class="col-12">
        <button class="btn btn-outline-secondary" type="button" id="resetForm" data-bs-toggle="tooltip" data-bs-placement="right" title="Clears all data out of the form and resets to a 10 user ATS only imp">Reset Form</button>
        <!-- <button class="btn btn-primary" type="submit">Submit form</button> -->
        <button id="saveDraft" class="btn btn-secondary" type="button" onclick="saveDraft();" data-bs-toggle="tooltip" data-bs-placement="right" title="This will generate a short url that can be used to access this data">Save Draft</button>
        <button id="generateProposal" class="btn btn-primary" type="button" onclick="generate();">Generate Proposal</button>
      </div>
    </div>

    <br /><br />
    <h1 class="display-6">Pricing Results</h1>
    <div class="row">
      <div class="col-sm-6">
        <table class="table table-striped table-hover">
          <tbody>
            <tr>
              <td>Client:</td>
              <td><span id="pricing_companyName"></span></td>
            </tr>
            <tr>
              <td>Ballpark:</td>
              <td><span id="pricing_ballpark"></span></td>
            </tr>
            <tr>
              <td>Base Pricing:</td>
              <td>
                <span id="pricing_basePricing"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                <small><span class="text-muted" id="discount"></span></small>
              </td>
            </tr>
            <tr>
              <td>Additions:</td>
              <td><span id="pricing_additions"></span></td>
            </tr>
            <tr>
              <td>Total Amount:</td>
              <td><span id="pricing_totalAmt" class=""></span>&nbsp;&nbsp;&nbsp;<span id="pricing_totalAmt_override" class=""></span></td>
            </tr>
            <tr id="shortUrl_tr" class="d-none">
              <td>Link:</td>
              <td><span id="shortUrl" class=""></span></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <br>
    <div class="accordion" id="accordionExample">
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingOne">
          <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
            Pricing Details
          </button>
        </h2>
        <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#accordionExample">
          <div class="accordion-body">
            <a href="" id="shortUrl2" class=""></a>
            <!-- This stores the data that will be shown so we can save for later. It's a sanitized version of rawOutput -->
            <pre><span id="dataOutput" class=""></span></pre>
          </div>
        </div>
      </div>
    </div>

    <!-- This stores the data to be sent to the generating document -->
    <pre><span id="rawOutput" class="d-none"></span></pre>
    <pre><a href="" id="linkURL" class="d-none">Link to this Pricing</a></pre>
  </div>

  <script>
    //
    // Form Validation
    //
    (function () {
      "use strict";
      window.addEventListener(
        "load",
        function () {
          // Fetch all the forms we want to apply custom Bootstrap validation styles to
          var forms = document.getElementsByClassName("needs-validation");
          // Loop over them and prevent submission
          var validation = Array.prototype.filter.call(
            forms,
            function (form) {
              form.addEventListener(
                "submit",
                function (event) {
                  if (form.checkValidity() === false) {
                    event.preventDefault();
                    event.stopPropagation();
                  }
                  form.classList.add("was-validated");
                },
                false
              );
            }
          );
        },
        false
      );
    })();
  </script>

  <!-- Bootstrap bundle-->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW" crossorigin="anonymous"></script>
</body>

</html>