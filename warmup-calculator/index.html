<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barbell Warm-up Set Calculator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        input, button, select, textarea {
            margin: 10px 0;
        }
        .form-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .form-group label {
            margin-right: 10px;
        }
        .form-group select, .form-group input {
            flex: 1;
            max-width: 200px;
        }
        .textarea-container {
            display: none;
            width: 100%;
        }
        .textarea-container textarea {
            width: 100%;
            box-sizing: border-box;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #000;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
        }
        .warning {
            background-color: red;
            color: white;
        }
        .close-warning {
            background-color: orange;
            color: white;
        }
        @media print {
            body * {
                visibility: hidden;
            }
            #printableArea, #printableArea * {
                visibility: visible;
            }
            #printableArea {
                position: absolute;
                left: 0;
                top: 0;
            }
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <h1>Barbell Warm-up Set Calculator</h1>
    <div class="form-group">
        <label for="liftSelect1">Lift 1:</label>
        <select id="liftSelect1">
            <option value="">(Select Lift)</option>
        </select>
        <input type="number" id="targetWeight1" min="45" step="0.25" placeholder="Target Weight">
    </div>
    <div class="form-group">
        <label for="liftSelect2">Lift 2:</label>
        <select id="liftSelect2">
            <option value="">(Select Lift)</option>
        </select>
        <input type="number" id="targetWeight2" min="45" step="0.25" placeholder="Target Weight">
    </div>
    <button onclick="window.print()">Print</button>
    <br>
    <button onclick="toggleTextarea('config')">Show Config</button>
    <div id="configContainer" class="textarea-container">
        <label for="configTextarea">Config JSON:</label>
        <textarea id="configTextarea" rows="10"></textarea>
    </div>
    <br>
    <button onclick="toggleTextarea('inventory')">Show Inventory</button>
    <div id="inventoryContainer" class="textarea-container">
        <label for="inventoryTextarea">Inventory JSON:</label>
        <textarea id="inventoryTextarea" rows="10"></textarea>
    </div>
    <br>
    <button onclick="calculateWarmupSets()">Recalculate</button>

    <div id="printableArea">
        <div id="lift1Container" class="hidden">
            <h2 id="liftName1">Warm-up Sets for Lift 1</h2>
            <table>
                <thead id="warmupHeader1">
                    <tr>
                        <th>Weight</th>
                    </tr>
                </thead>
                <tbody id="warmupTable1">
                </tbody>
                <tfoot id="warmupFooter1">
                </tfoot>
            </table>
        </div>

        <div id="lift2Container" class="hidden">
            <h2 id="liftName2">Warm-up Sets for Lift 2</h2>
            <table>
                <thead id="warmupHeader2">
                    <tr>
                        <th>Weight</th>
                    </tr>
                </thead>
                <tbody id="warmupTable2">
                </tbody>
                <tfoot id="warmupFooter2">
                </tfoot>
            </table>
        </div>
    </div>

    <script>
        let inventory = null;
        let config = null;

        // Fetch JSON data when the page loads
        window.addEventListener('DOMContentLoaded', async () => {
            await fetchData();

            // Populate lift options
            populateLiftOptions();

            // Populate textareas with JSON data
            document.getElementById('configTextarea').value = JSON.stringify(config, null, 2);
            document.getElementById('inventoryTextarea').value = JSON.stringify(inventory, null, 2);

            // Add event listeners for automatic calculation
            document.getElementById('liftSelect1').addEventListener('change', () => {
                document.getElementById('targetWeight1').focus();
                document.getElementById('liftName1').textContent = document.getElementById('liftSelect1').value;
                calculateWarmupSets();
            });
            document.getElementById('liftSelect2').addEventListener('change', () => {
                document.getElementById('targetWeight2').focus();
                document.getElementById('liftName2').textContent = document.getElementById('liftSelect2').value;
                calculateWarmupSets();
            });
            document.getElementById('targetWeight1').addEventListener('input', calculateWarmupSets);
            document.getElementById('targetWeight2').addEventListener('input', calculateWarmupSets);
        });

        async function fetchData() {
            try {
                const inventoryResponse = await fetch('inventory.json');
                const configResponse = await fetch('config.json');

                if (!inventoryResponse.ok || !configResponse.ok) {
                    throw new Error('Failed to load JSON files');
                }

                inventory = await inventoryResponse.json();
                config = await configResponse.json();

                console.log('Inventory:', inventory);
                console.log('Config:', config);

            } catch (error) {
                console.error('Error fetching or parsing JSON:', error);
            }
        }

        function populateLiftOptions() {
            const liftSelects = [document.getElementById('liftSelect1'), document.getElementById('liftSelect2')];
            liftSelects.forEach(select => {
                select.innerHTML = '<option value="">(Select Lift)</option>';
                config.lifts.forEach(lift => {
                    const option = document.createElement('option');
                    option.value = lift;
                    option.textContent = lift;
                    select.appendChild(option);
                });
            });
        }

        function clearTables() {
            const warmupTables = [document.getElementById('warmupTable1'), document.getElementById('warmupTable2')];
            const warmupHeaders = [document.getElementById('warmupHeader1'), document.getElementById('warmupHeader2')];
            const warmupFooters = [document.getElementById('warmupFooter1'), document.getElementById('warmupFooter2')];
            const containers = [document.getElementById('lift1Container'), document.getElementById('lift2Container')];
            warmupTables.forEach(table => table.innerHTML = '');
            warmupHeaders.forEach(header => header.innerHTML = '<tr><th>Weight</th></tr>');
            warmupFooters.forEach(footer => footer.innerHTML = '');
            containers.forEach(container => container.classList.add('hidden'));
        }

        async function calculateWarmupSets() {
            try {
                config = JSON.parse(document.getElementById('configTextarea').value);
                inventory = JSON.parse(document.getElementById('inventoryTextarea').value);
            } catch (error) {
                console.error('Error parsing JSON:', error);
                return;
            }

            const targetWeights = [parseFloat(document.getElementById('targetWeight1').value), parseFloat(document.getElementById('targetWeight2').value)];
            const warmupTables = [document.getElementById('warmupTable1'), document.getElementById('warmupTable2')];
            const warmupHeaders = [document.getElementById('warmupHeader1'), document.getElementById('warmupHeader2')];
            const warmupFooters = [document.getElementById('warmupFooter1'), document.getElementById('warmupFooter2')];
            const containers = [document.getElementById('lift1Container'), document.getElementById('lift2Container')];
            clearTables();

            targetWeights.forEach((targetWeight, index) => {
                const liftSelect = document.getElementById(`liftSelect${index + 1}`);
                if (!liftSelect.value || !targetWeight || targetWeight < inventory.barbell) {
                    warmupTables[index].innerHTML = '<tr><td colspan="5">Please enter a valid target weight greater than or equal to the barbell weight.</td></tr>';
                    return;
                }

                containers[index].classList.remove('hidden');

                // Calculate the weights and reps for each warm-up set
                const warmupSets = config.warmupPercentages.map(pct => ({
                    percentage: pct.percentage,
                    weight: Math.round(targetWeight * pct.percentage),
                    reps: pct.reps,
                    plates: calculatePlates(Math.round(targetWeight * pct.percentage))
                }));

                // Create header row with percentages, weights, and reps
                warmupSets.forEach(set => {
                    const headerCell = document.createElement('th');
                    headerCell.innerHTML = `${Math.round(set.percentage * 100)}%<br>${set.weight} lbs<br>${set.reps} reps`;
                    warmupHeaders[index].firstElementChild.appendChild(headerCell);
                });

                // Fill table with plate data
                inventory.plates.sort((a, b) => b.mass - a.mass); // Ensure plates are sorted descending

                inventory.plates.forEach(plate => {
                    const row = document.createElement('tr');
                    const weightCell = document.createElement('td');
                    weightCell.textContent = `${plate.mass}`;
                    if (config.showColors) {
                        weightCell.style.color = plate.color;
                    }
                    row.appendChild(weightCell);

                    warmupSets.forEach(set => {
                        const plateCell = document.createElement('td');
                        const plateCount = set.plates.find(p => p.mass === plate.mass);
                        if (plateCount) {
                            plateCell.textContent = plateCount.count > 1 ? plateCount.count : '1';
                        } else {
                            plateCell.textContent = '';
                        }
                        row.appendChild(plateCell);
                    });

                    warmupTables[index].appendChild(row);
                });

                // Add total weight row
                const totalWeightRow = document.createElement('tr');
                const totalWeightCell = document.createElement('td');
                totalWeightCell.textContent = 'Total Weight';
                totalWeightRow.appendChild(totalWeightCell);

                let warning = false;
                warmupSets.forEach(set => {
                    const totalWeightDataCell = document.createElement('td');
                    const actualWeight = set.plates.reduce((sum, plate) => sum + plate.mass * plate.count * 2, inventory.barbell);
                    totalWeightDataCell.textContent = actualWeight;

                    const weightDifference = Math.abs(actualWeight - set.weight);
                    if (weightDifference > 5) {
                        totalWeightDataCell.classList.add('warning');
                        warning = true;
                    } else if (weightDifference > 0) {
                        totalWeightDataCell.classList.add('close-warning');
                    }

                    totalWeightRow.appendChild(totalWeightDataCell);
                });

                warmupFooters[index].appendChild(totalWeightRow);

                if (warning) {
                    const warningRow = document.createElement('tr');
                    const warningCell = document.createElement('td');
                    warningCell.colSpan = warmupSets.length + 1;
                    warningCell.classList.add('warning');
                    warningCell.textContent = 'Warning: Unable to match the desired weight with available plates.';
                    warmupFooters[index].appendChild(warningRow);
                }
            });
        }

        function calculatePlates(weight) {
            let weightNeeded = weight - inventory.barbell;
            if (weightNeeded < 0) return [];

            weightNeeded /= 2; // Plates are added on both sides
            const platesToUse = [];

            inventory.plates.sort((a, b) => b.mass - a.mass); // Sort plates descending

            for (const plate of inventory.plates) {
                let pairsNeeded = 0;
                while (weightNeeded >= plate.mass && pairsNeeded < plate.pairs) {
                    weightNeeded -= plate.mass;
                    pairsNeeded++;
                }
                if (pairsNeeded > 0) {
                    platesToUse.push({ mass: plate.mass, count: pairsNeeded });
                }
            }

            // Check if the weight was successfully allocated
            if (weightNeeded > 0) {
                console.warn(`Cannot exactly match the weight ${weight}. Remaining weight: ${weightNeeded * 2}`);
                return platesToUse; // Return partial allocations
            } else {
                return platesToUse;
            }
        }

        function toggleTextarea(type) {
            const container = document.getElementById(`${type}Container`);
            const button = document.querySelector(`button[onclick="toggleTextarea('${type}')"]`);
            if (container.style.display === 'none' || container.style.display === '') {
                container.style.display = 'block';
                button.textContent = `Hide ${type.charAt(0).toUpperCase() + type.slice(1)}`;
            } else {
                container.style.display = 'none';
                button.textContent = `Show ${type.charAt(0).toUpperCase() + type.slice(1)}`;
            }
        }
    </script>
</body>
</html>
